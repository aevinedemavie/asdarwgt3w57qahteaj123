-- Services
local RS = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local TeleportService = game:GetService("TeleportService")

-- Remotes
local PurchaseUpgrade = RS.Utilities.TypedRemote.PurchaseUpgrade
local Rebirth = RS.Utilities.TypedRemote.Rebirth
local UpgradeStand = RS.Utilities.TypedRemote.UpgradeStand

-- Player
local lp = Players.LocalPlayer

local function getRoot()
    local char = lp.Character
    return char and char:FindFirstChild("HumanoidRootPart")
end

local function isAlive()
    local char = lp.Character
    if not char then return false end
    local hum = char:FindFirstChildOfClass("Humanoid")
    return hum and hum.Health > 0
end

local function waitAlive()
    while not isAlive() do task.wait(0.1) end
    task.wait(0.5)
end

local function setupDeath(char)
    local hum = char:WaitForChild("Humanoid")
    hum.Died:Connect(function()
        task.wait(0.3)
        pcall(function() lp:LoadCharacter() end)
    end)
end

if lp.Character then setupDeath(lp.Character) end
lp.CharacterAdded:Connect(setupDeath)

task.spawn(function()
    lp.Idled:Connect(function()
        VirtualUser:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
        task.wait(1)
        VirtualUser:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
    end)
end)

task.spawn(function()
    while true do
        if not lp.Character or not getRoot() then
            pcall(function() TeleportService:Teleport(game.PlaceId, lp) end)
        end
        task.wait(3)
    end
end)

-- Priority 1: Purchase Upgrade "1"
task.spawn(function()
    while true do
        pcall(function()
            PurchaseUpgrade:FireServer("1")
        end)
        task.wait(0.001)
    end
end)

-- Priority 2: Rebirth
task.spawn(function()
    while true do
        pcall(function()
            Rebirth:InvokeServer()
        end)
        task.wait(0.001)
    end
end)

-- Priority 5: Upgrade Stand (Base)
task.spawn(function()
    while true do
        pcall(function()
            UpgradeStand:FireServer(math.random(1, 70))
        end)
        task.wait(0.001)
    end
end)

-- Priority 4: Auto Collect Currency (Bubble)
task.spawn(function()
    while true do
        if not isAlive() then waitAlive() continue end
        pcall(function()
            local root = getRoot()
            if not root then return end
            local cf = workspace:FindFirstChild("CurrencyFolder")
            if not cf then return end
            for _, currency in pairs(cf:GetChildren()) do
                if not currency or not currency.Parent then continue end
                local pos = currency:IsA("BasePart") and currency.Position
                    or (currency:FindFirstChildWhichIsA("BasePart") and currency:FindFirstChildWhichIsA("BasePart").Position)
                if pos then
                    root = getRoot()
                    if not root then return end
                    root.CFrame = CFrame.new(pos)
                end
            end
        end)
        task.wait(0.001)
    end
end)

-- Priority 6: Auto Collect Cash from Stands
task.spawn(function()
    while true do
        if not isAlive() then waitAlive() continue end
        pcall(function()
            local root = getRoot()
            if not root then return end
            for _, plot in pairs(workspace.Plots:GetChildren()) do
                local floors = plot:FindFirstChild("Floors")
                if not floors then continue end
                for _, floor in pairs(floors:GetChildren()) do
                    local stands = floor:FindFirstChild("Stands")
                    if not stands then continue end
                    for _, stand in pairs(stands:GetChildren()) do
                        local cashModel = stand:FindFirstChild("CashModel")
                        if not cashModel then continue end
                        local touchPart = cashModel:FindFirstChild("TouchPart")
                        if not touchPart then continue end
                        root = getRoot()
                        if not root then return end
                        firetouchinterest(root, touchPart, 0)
                        firetouchinterest(root, touchPart, 1)
                    end
                end
            end
        end)
        task.wait(0.001)
    end
end)

-- Remove Crushers/Hitboxes
task.spawn(function()
    while true do
        pcall(function()
            for _, name in pairs({"KillCrushers", "Hitboxes", "Crushers"}) do
                local folder = workspace:FindFirstChild(name)
                if folder then
                    for _, v in pairs(folder:GetChildren()) do
                        v:Destroy()
                    end
                end
            end
        end)
        task.wait(0.001)
    end
end)

local rarityMap = {
    ["Karkerkar Kurkur"] = "Divine",
    ["Job Job Sahur"] = "Divine",
    ["Esok Sekolah"] = "Divine",
    ["Ben"] = "Admin",
    ["Smurf Cat"] = "Admin",
    ["Skibidi Toilet"] = "Admin",
    ["Troppi Trippa"] = "Event",
    ["Blueberrinni Octopusini"] = "Event",
    ["Tung Tung Ramadan"] = "Event",
    ["Esok Lebaran"] = "Event",
    ["La Vacca Ramadanita"] = "Event",
    ["Tralaledon"] = "Event",
}

local rarityPriority = {Divine = 1, Admin = 2, Event = 3}

local detectedEntities = {}

local function scanEntities()
    local EntitiesFolder = workspace:FindFirstChild("EntitiesFolder")
    if not EntitiesFolder then return end

    for _, entity in ipairs(EntitiesFolder:GetChildren()) do
        local mesh = entity:FindFirstChild("Mesh")
        local prompt = mesh and mesh:FindFirstChildOfClass("ProximityPrompt")
        if not (mesh and prompt) then continue end

        local billboard = entity:FindFirstChild("EntityBillboardTemplate", true)
        if not billboard then continue end

        for _, label in ipairs(billboard:GetDescendants()) do
            if label:IsA("TextLabel") and label.Text ~= "" then
                local rarity = rarityMap[label.Text]
                if rarity then
                    local id = entity:GetDebugId()
                    if not detectedEntities[id] then
                        detectedEntities[id] = {
                            name = label.Text,
                            rarity = rarity,
                            priority = rarityPriority[rarity] or 99,
                            mesh = mesh,
                            prompt = prompt,
                            detectedAt = tick(),
                            entity = entity,
                        }
                        print("[DETECTED - WAITING 15s] [" .. rarity .. "] " .. label.Text)
                    end
                end
                break
            end
        end
    end
end

local function collectEntities()
    if not isAlive() then waitAlive() end
    local root = getRoot()
    if not root then return end

    local now = tick()
    local readyTargets = {}

    for id, data in pairs(detectedEntities) do
        if not data.entity or not data.entity.Parent then
            detectedEntities[id] = nil
            continue
        end
        if (now - data.detectedAt) >= 15 then
            table.insert(readyTargets, data)
        end
    end

    table.sort(readyTargets, function(a, b) return a.priority < b.priority end)

    local CarryZone = workspace:FindFirstChild("CarryZone")

    for _, t in ipairs(readyTargets) do
        if not t.entity or not t.entity.Parent then continue end
        if not isAlive() then waitAlive() end
        root = getRoot()
        if not root then return end

        local ok = pcall(function()
            root.CFrame = t.mesh.CFrame + Vector3.new(0, 5, 0)
        end)
        if not ok then continue end
        task.wait(0.4)

        pcall(function() fireproximityprompt(t.prompt) end)
        task.wait(0.4)
        print("[" .. t.rarity .. "] " .. t.name .. " - COLLECTED")

        if CarryZone then
            pcall(function()
                root = getRoot()
                if root then
                    root.CFrame = CarryZone.CFrame + Vector3.new(0, 5, 0)
                end
            end)
            task.wait(0.8)
        end

        local id = t.entity:GetDebugId()
        detectedEntities[id] = nil
    end
end

-- Priority 3: Entity Collector Loop
while true do
    pcall(scanEntities)
    pcall(collectEntities)
    task.wait(0.5)
end
